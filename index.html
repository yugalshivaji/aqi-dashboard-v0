<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AQI NCR Delhi - Gov Edition | Govt. of NCT of Delhi</title>
    <meta name="description" content="Official Air Quality Portal - Empowering 30 Million Citizens of Delhi NCR with real-time data, AI-driven policy analytics, and rapid grievance redressal">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --gov-blue: #003366;
            --gov-gold: #FFD700;
            --gov-red: #FF4500;
            --gov-green: #228B22;
            --gov-light-blue: #1E90FF;
            --gov-dark: #0A2647;
            --gov-white: #FFFFFF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Calibri', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%);
            min-height: 100vh;
        }
        
        /* Header Banner */
        .gov-header {
            background: linear-gradient(90deg, var(--gov-blue) 0%, #004080 100%);
            color: white;
            padding: 8px 0;
            font-size: 0.9rem;
            border-bottom: 4px solid var(--gov-gold);
        }
        
        .gov-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .gov-header .right-logos {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        /* Navigation */
        .navbar-gov {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-bottom: 2px solid var(--gov-gold);
        }
        
        .navbar-brand-gov {
            font-weight: 700;
            color: var(--gov-blue) !important;
            font-size: 1.5rem;
        }
        
        .navbar-brand-gov i {
            color: var(--gov-red);
            margin-right: 10px;
        }
        
        .nav-link-gov {
            color: var(--gov-blue) !important;
            font-weight: 500;
            margin: 0 10px;
            padding: 10px 15px !important;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .nav-link-gov:hover {
            background: rgba(0, 51, 102, 0.1);
            color: var(--gov-blue) !important;
        }
        
        .nav-link-gov.active {
            background: var(--gov-blue);
            color: white !important;
        }
        
        /* Hero Section */
        .hero-gov {
            background: linear-gradient(rgba(0, 51, 102, 0.9), rgba(0, 64, 128, 0.9)), 
                        url('https://images.unsplash.com/photo-1587474260584-136574528ed5?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .hero-subtitle {
            font-size: 1.5rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .hero-badge {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--gov-gold);
            border-radius: 50px;
            padding: 8px 25px;
            display: inline-block;
            margin: 10px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        /* Live AQI Display */
        .live-aqi-section {
            margin-top: -100px;
            position: relative;
            z-index: 10;
        }
        
        .live-aqi-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-left: 8px solid var(--gov-red);
            margin-bottom: 20px;
        }
        
        .aqi-display-container {
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }
        
        .aqi-value {
            font-size: 4rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 10px;
        }
        
        .aqi-category {
            padding: 8px 25px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
            margin: 10px 0;
            font-size: 1.2rem;
        }
        
        /* AQI Colors */
        .aqi-bg-good { background: #00e400; color: white; }
        .aqi-bg-sat { background: #87c159; color: white; }
        .aqi-bg-mod { background: #ffff00; color: black; }
        .aqi-bg-poor { background: #ff7e00; color: white; }
        .aqi-bg-vpoor { background: #ff0000; color: white; }
        .aqi-bg-severe { background: #8f3f97; color: white; }
        .aqi-bg-hazardous { background: #7e0023; color: white; }
        
        .pollutant-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .pollutant-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid #e0e0e0;
            transition: transform 0.2s;
        }
        
        .pollutant-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .pollutant-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin: 5px 0;
        }
        
        .pollutant-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .pollutant-unit {
            font-size: 0.75rem;
            color: #999;
        }
        
        .grap-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 25px;
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 50px;
            color: #333;
            font-weight: 600;
            text-decoration: none;
            transition: 0.3s;
        }
        
        .grap-link:hover {
            background: var(--gov-red);
            border-color: var(--gov-red);
            color: white;
        }
        
        .data-source {
            font-size: 0.9rem;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 15px;
        }
        
        /* Location Selector */
        .location-selector {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.04);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .location-selector select {
            border: 2px solid #eee;
            height: 50px;
            font-weight: 500;
        }
        
        .location-selector select:focus {
            border-color: var(--gov-blue);
            box-shadow: 0 0 0 0.25rem rgba(0, 51, 102, 0.25);
        }
        
        /* Map Container */
        #aqiMap {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            z-index: 1;
        }
        
        /* PREDICTION DASHBOARD STYLES */
        .prediction-section {
            padding: 80px 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .section-title {
            color: var(--gov-blue);
            font-weight: 700;
            margin-bottom: 50px;
            position: relative;
            padding-bottom: 15px;
        }
        
        .section-title:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: var(--gov-gold);
        }
        
        .prediction-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            height: 100%;
            margin-bottom: 20px;
        }
        
        .prediction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        }
        
        .prediction-header {
            padding: 20px;
            text-align: center;
            position: relative;
            color: white;
        }
        
        .prediction-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .prediction-header h4 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .prediction-risk {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
        }
        
        .prediction-body {
            padding: 20px;
        }
        
        .prediction-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .metric-value {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .prediction-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .prediction-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.9rem;
        }
        
        .prediction-list li:last-child {
            border-bottom: none;
        }
        
        .service-status {
            margin-bottom: 15px;
        }
        
        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .service-item:last-child {
            border-bottom: none;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 10px;
        }
        
        .status-indicator.active {
            background-color: #28a745;
        }
        
        .status-indicator.warning {
            background-color: #ffc107;
        }
        
        .status-indicator.inactive {
            background-color: #dc3545;
        }
        
        .status-text {
            font-size: 0.85rem;
            color: #666;
        }
        
        .uptime-metric, .response-time {
            display: inline-block;
            width: 48%;
        }
        
        .alert-panel {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .alert-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-container {
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .alert-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .alert-item.critical {
            background: rgba(220, 53, 69, 0.1);
            border-left: 4px solid #dc3545;
        }
        
        .alert-item.warning {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
        }
        
        .alert-item.info {
            background: rgba(23, 162, 184, 0.1);
            border-left: 4px solid #17a2b8;
        }
        
        .alert-icon {
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .alert-content {
            flex-grow: 1;
        }
        
        .alert-time {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
        }
        
        .heatmap-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 5px;
        }
        
        .legend-color.low { background: #28a745; }
        .legend-color.medium { background: #ffc107; }
        .legend-color.high { background: #dc3545; }
        
        /* Role Cards */
        .role-section {
            padding: 80px 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .role-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
            border: 1px solid #e0e0e0;
        }
        
        .role-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .role-header {
            padding: 25px 25px 15px;
            text-align: center;
            background: linear-gradient(135deg, var(--gov-blue) 0%, #004080 100%);
            color: white;
        }
        
        .role-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .role-body {
            padding: 25px;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
        
        .feature-list i {
            color: var(--gov-green);
            margin-right: 10px;
        }
        
        .role-btn {
            background: var(--gov-blue);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-weight: 600;
            width: 100%;
            transition: background 0.3s;
            margin-top: 20px;
        }
        
        .role-btn:hover {
            background: #004080;
            color: white;
        }
        
        /* Stats Section */
        .stats-section {
            background: linear-gradient(135deg, var(--gov-blue) 0%, #004080 100%);
            color: white;
            padding: 60px 0;
            position: relative;
            overflow: hidden;
        }
        
        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            color: var(--gov-gold);
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Features Section */
        .features-section {
            padding: 80px 0;
            background: white;
        }
        
        .feature-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            height: 100%;
            border-left: 5px solid var(--gov-light-blue);
            transition: all 0.3s;
        }
        
        .feature-card:hover {
            background: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: var(--gov-blue);
            margin-bottom: 20px;
        }
        
        /* Footer */
        .gov-footer {
            background: linear-gradient(135deg, var(--gov-dark) 0%, #0c2d4d 100%);
            color: white;
            padding: 50px 0 20px;
        }
        
        .footer-logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin-bottom: 20px;
        }
        
        .footer-links h5 {
            color: var(--gov-gold);
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .footer-links ul {
            list-style: none;
            padding: 0;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: var(--gov-gold);
        }
        
        .copyright {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
            margin-top: 30px;
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--gov-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Toast Notification */
        .toast-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--gov-blue);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 99999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast-alert.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-content {
            display: flex;
            align-items: center;
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .pollutant-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }
            
            .hero-subtitle {
                font-size: 1.2rem;
            }
            
            .aqi-value {
                font-size: 3.5rem;
            }
            
            .live-aqi-section {
                margin-top: 30px;
            }
            
            .pollutant-grid {
                grid-template-columns: 1fr;
            }
            
            .role-card {
                margin-bottom: 30px;
            }
            
            .gov-header .container {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .gov-header .right-logos {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .prediction-metric {
                flex-direction: column;
            }
            
            .uptime-metric, .response-time {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .heatmap-legend {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            /* Heatmap Chart Styles */
.heatmap-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
}

.heatmap-data {
    border-top: 1px solid #e9ecef;
    padding-top: 15px;
}

.heatmap-data .badge {
    font-size: 0.75rem;
    padding: 3px 8px;
    margin-top: 5px;
}
        }
    </style>
    
</head>
<body>
  

    <!-- Government Header -->
    <div class="gov-header">
        <div class="container">
            <div class="left-text">
                <strong>GOVT. OF NCT OF DELHI</strong> | Official Air Quality Portal
            </div>
            <div class="right-logos">
                <span>Azadi Ka Amrit Mahotsav</span>
                <span class="badge bg-danger">G20 Bharat 2025 INDIA</span>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Flag_of_India.svg/640px-Flag_of_India.svg.png" 
                     alt="Indian Flag" height="25" style="border-radius: 3px;">
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-gov">
        <div class="container">
            <a class="navbar-brand navbar-brand-gov" href="#">
                <i class="fas fa-wind"></i>AQI NCR Delhi - Gov Edition
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link nav-link-gov active" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-gov" href="#dashboard">Live Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-gov" href="#predictions">AI Predictions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-gov" href="#roles">Portals</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-gov" href="#features">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-danger ms-2" href="auth.html">
                            <i class="fas fa-sign-in-alt me-2"></i>Login / Register
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-gov">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <h1 class="hero-title">Swachh Vayu, Swasth Bharat</h1>
                    <p class="hero-subtitle">
                        Empowering 30 Million Citizens of Delhi NCR with real-time data, 
                        AI-driven policy analytics, and rapid grievance redressal.
                    </p>
                    <div class="mt-4">
                        <span class="hero-badge">Real-time Monitoring</span>
                        <span class="hero-badge">AI-Powered Analytics</span>
                        <span class="hero-badge">Failure Prediction</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Live AQI Dashboard Section -->
    <section class="live-aqi-section" id="dashboard">
        <div class="container">
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="location-selector">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-map-marker-alt text-primary fa-lg me-3"></i>
                            <div class="flex-grow-1">
                                <select class="form-select" id="stationSelect">
                                    <option value="current" selected>üìç Use My Live GPS Location</option>
                                    <optgroup label="Central Delhi">
                                        <option value="28.6317,77.2457">ITO, New Delhi</option>
                                        <option value="28.6365,77.1994">Mandir Marg</option>
                                        <option value="28.5632,77.1869">R.K. Puram</option>
                                    </optgroup>
                                    <optgroup label="East Delhi / Noida">
                                        <option value="28.6469,77.3160">Anand Vihar</option>
                                        <option value="28.6245,77.3577">Noida Sector 62</option>
                                        <option value="28.5672,77.3855">Noida Sector 125</option>
                                    </optgroup>
                                    <optgroup label="West Delhi / Gurugram">
                                        <option value="28.6683,77.1167">Punjabi Bagh</option>
                                        <option value="28.5706,77.0715">Dwarka Sector 8</option>
                                        <option value="28.4227,77.0667">Gurugram Sector 51</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="live-aqi-card">
                        <div class="d-flex align-items-center mb-4">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                            <h4 class="mb-0">LIVE SENSOR DATA - <span id="stationName">NEW DELHI</span></h4>
                        </div>
                        
                        <div class="aqi-display-container text-center">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-broadcast-tower me-1"></i> 
                                <span id="currentLocation">Detecting Station...</span>
                            </h6>
                            
                            <div class="aqi-value" id="mainAQI">--</div>
                            <div class="aqi-category" id="mainAQICategory">Wait...</div>
                            
                            <div class="mt-4">
                                <button class="grap-link" id="grapLink" data-bs-toggle="modal" data-bs-target="#grapModal">
                                    <i class="fas fa-info-circle me-1"></i> Check GRAP Status
                                </button>
                            </div>
                            
                            <div class="mt-4 small text-muted">
                                Primary Pollutant: <span class="fw-bold" id="domPol">--</span>
                            </div>
                            
                            <p class="data-source mb-0">
                                <i class="fas fa-database me-2"></i>
                                Data Source: Central Pollution Control Board (CPCB) via AQICN API
                            </p>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="live-aqi-card">
                        <h5 class="mb-4"><i class="fas fa-vial me-2"></i>Pollutant Breakdown</h5>
                        <div class="pollutant-grid">
                            <div class="pollutant-card">
                                <div class="pollutant-label">PM 2.5</div>
                                <div class="pollutant-value text-primary" id="p-pm25">-</div>
                                <div class="pollutant-unit">¬µg/m¬≥</div>
                            </div>
                            <div class="pollutant-card">
                                <div class="pollutant-label">PM 10</div>
                                <div class="pollutant-value text-primary" id="p-pm10">-</div>
                                <div class="pollutant-unit">¬µg/m¬≥</div>
                            </div>
                            <div class="pollutant-card">
                                <div class="pollutant-label">NO‚ÇÇ</div>
                                <div class="pollutant-value" id="p-no2">-</div>
                                <div class="pollutant-unit">ppb</div>
                            </div>
                            <div class="pollutant-card">
                                <div class="pollutant-label">SO‚ÇÇ</div>
                                <div class="pollutant-value" id="p-so2">-</div>
                                <div class="pollutant-unit">ppb</div>
                            </div>
                            <div class="pollutant-card">
                                <div class="pollutant-label">O‚ÇÉ</div>
                                <div class="pollutant-value" id="p-o3">-</div>
                                <div class="pollutant-unit">ppb</div>
                            </div>
                            <div class="pollutant-card">
                                <div class="pollutant-label">CO</div>
                                <div class="pollutant-value" id="p-co">-</div>
                                <div class="pollutant-unit">ppm</div>
                            </div>
                            <div class="pollutant-card">
                                <div class="pollutant-label">Temperature</div>
                                <div class="pollutant-value text-info" id="p-temp">-</div>
                                <div class="pollutant-unit">¬∞C</div>
                            </div>
                            <div class="pollutant-card">
                                <div class="pollutant-label">Humidity</div>
                                <div class="pollutant-value text-info" id="p-hum">-</div>
                                <div class="pollutant-unit">%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="live-aqi-card">
                        <h5 class="mb-4"><i class="fas fa-map-marked-alt me-2"></i>Monitoring Station Location</h5>
                        <div id="aqiMap"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- AI Failure Prediction Dashboard -->
    <section class="prediction-section" id="predictions">
        <div class="container">
            <h2 class="text-center section-title"><i class="fas fa-robot me-2"></i>AI-Powered Failure Prediction System</h2>
            <p class="text-center text-muted mb-5">Proactive monitoring to prevent system failures before they occur</p>
            
            <!-- Prediction Cards -->
            <div class="row g-4">
                <!-- Sensor Health Prediction -->
                <div class="col-md-6 col-lg-4">
                    <div class="prediction-card">
                        <div class="prediction-header bg-danger text-white">
                            <div class="prediction-icon">
                                <i class="fas fa-sensor"></i>
                            </div>
                            <h4>Sensor Failure Prediction</h4>
                            <div class="prediction-risk">HIGH RISK</div>
                        </div>
                        <div class="prediction-body">
                            <div class="prediction-metric">
                                <span class="metric-label">At-risk Sensors:</span>
                                <span class="metric-value" id="atRiskSensors">12</span>
                            </div>
                            <div class="prediction-metric">
                                <span class="metric-label">Predicted Failures (24h):</span>
                                <span class="metric-value" id="predictedFailures">3-5</span>
                            </div>
                            <div class="prediction-list">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>High Risk Locations:</h6>
                                <ul id="sensorRiskList">
                                    <!-- Dynamically populated -->
                                </ul>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="viewSensorHealth()">
                                <i class="fas fa-chart-line me-1"></i> View Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Data Anomaly Detection -->
                <div class="col-md-6 col-lg-4">
                    <div class="prediction-card">
                        <div class="prediction-header bg-warning text-dark">
                            <div class="prediction-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <h4>Data Anomaly Detection</h4>
                            <div class="prediction-risk">MEDIUM RISK</div>
                        </div>
                        <div class="prediction-body">
                            <div class="prediction-metric">
                                <span class="metric-label">Anomalies Detected:</span>
                                <span class="metric-value" id="anomaliesCount">8</span>
                            </div>
                            <div class="prediction-metric">
                                <span class="metric-label">Data Quality Score:</span>
                                <span class="metric-value" id="dataQuality">87%</span>
                            </div>
                            <div class="prediction-progress">
                                <div class="progress">
                                    <div class="progress-bar bg-success" id="dataQualityBar" style="width: 87%"></div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <span class="badge bg-info me-2">Missing Data: 2%</span>
                                <span class="badge bg-warning">Spike Detected: 5%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API & Service Health -->
                <div class="col-md-6 col-lg-4">
                    <div class="prediction-card">
                        <div class="prediction-header bg-info text-white">
                            <div class="prediction-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            <h4>Service Health Monitor</h4>
                            <div class="prediction-risk">LOW RISK</div>
                        </div>
                        <div class="prediction-body">
                            <div class="service-status">
                                <div class="service-item">
                                    <span>AQICN API:</span>
                                    <span class="status-indicator active"></span>
                                    <span class="status-text">Active</span>
                                </div>
                                <div class="service-item">
                                    <span>GPS Service:</span>
                                    <span class="status-indicator warning"></span>
                                    <span class="status-text">Degraded</span>
                                </div>
                                <div class="service-item">
                                    <span>Map Services:</span>
                                    <span class="status-indicator active"></span>
                                    <span class="status-text">Active</span>
                                </div>
                                <div class="service-item">
                                    <span>Data Processing:</span>
                                    <span class="status-indicator active"></span>
                                    <span class="status-text">Active</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="uptime-metric">
                                    <small>System Uptime: <strong id="systemUptime">99.8%</strong></small>
                                </div>
                                <div class="response-time">
                                    <small>Avg Response: <strong id="avgResponse">145ms</strong></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Predictive Maintenance Schedule -->
                <div class="col-md-6 col-lg-6">
                    <div class="prediction-card h-100">
                        <div class="prediction-header bg-primary text-white">
                            <div class="prediction-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h4>Predictive Maintenance Schedule</h4>
                        </div>
                        <div class="prediction-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Sensor ID</th>
                                        <th>Location</th>
                                        <th>Last Maintenance</th>
                                        <th>Predicted Failure</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenanceSchedule">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

<!-- Failure Probability Heatmap -->
<div class="col-md-6 col-lg-6">
    <div class="prediction-card h-100">
        <div class="prediction-header bg-success text-white">
            <div class="prediction-icon">
                <i class="fas fa-fire"></i>
            </div>
            <h4>Failure Probability Heatmap</h4>
        </div>
        <div class="prediction-body">
            <div class="heatmap-container" style="height: 250px; position: relative;">
                <canvas id="failureHeatmapChart"></canvas>
            </div>
            <div class="heatmap-data mt-3">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="small text-muted">Highest Risk</div>
                        <div class="fw-bold" id="highestRiskLocation">Anand Vihar</div>
                        <span class="badge bg-danger" id="highestRiskValue">82%</span>
                    </div>
                    <div class="col-4">
                        <div class="small text-muted">Avg Risk</div>
                        <div class="fw-bold">Delhi NCR</div>
                        <span class="badge bg-warning" id="avgRiskValue">56%</span>
                    </div>
                    <div class="col-4">
                        <div class="small text-muted">Lowest Risk</div>
                        <div class="fw-bold" id="lowestRiskLocation">Dwarka</div>
                        <span class="badge bg-success" id="lowestRiskValue">15%</span>
                    </div>
                </div>
            </div>
            <div class="heatmap-legend mt-3">
                <span class="legend-item"><span class="legend-color low"></span> Low Risk (0-30%)</span>
                <span class="legend-item"><span class="legend-color medium"></span> Medium Risk (31-60%)</span>
                <span class="legend-item"><span class="legend-color high"></span> High Risk (61-100%)</span>
            </div>
        </div>
    </div>
</div>

            <!-- Prediction Alerts Panel -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert-panel">
                        <div class="alert-header">
                            <h5><i class="fas fa-bell me-2"></i>Active Predictions & Alerts</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshPredictions()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="alert-container" id="predictionAlerts">
                            <!-- Alerts will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Role Selection Section -->
    <section class="role-section" id="roles">
        <div class="container">
            <h2 class="text-center section-title">Portal Access - Choose Your Role</h2>
            <p class="text-center text-muted mb-5">Select your designated portal to access specialized features and tools</p>
            
            <div class="row g-4">
                <!-- Citizen Card -->
                <div class="col-lg-4">
                    <div class="role-card">
                        <div class="role-header">
                            <div class="role-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3>Jan Bhagidari (Citizen)</h3>
                            <p class="mb-0">Public Portal</p>
                        </div>
                        <div class="role-body">
                            <p>Access tools for reporting, monitoring, and staying informed about air quality in your area.</p>
                            <ul class="feature-list">
                                <li><i class="fas fa-check-circle"></i> Real-time AQI Dashboard</li>
                                <li><i class="fas fa-check-circle"></i> Pollution Complaint Submission</li>
                                <li><i class="fas fa-check-circle"></i> Health Recommendations</li>
                                <li><i class="fas fa-check-circle"></i> Nearby AQI Shelters</li>
                                <li><i class="fas fa-check-circle"></i> Policy Feedback System</li>
                            </ul>
                            <button class="role-btn" onclick="window.location.href='auth.html?role=citizen'">
                                <i class="fas fa-user me-2"></i>Access Citizen Portal
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Department Card -->
                <div class="col-lg-4">
                    <div class="role-card">
                        <div class="role-header" style="background: linear-gradient(135deg, var(--gov-green) 0%, #1e7a1e 100%);">
                            <div class="role-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <h3>Government Department</h3>
                            <p class="mb-0">Official Staff Portal</p>
                        </div>
                        <div class="role-body">
                            <p>Manage complaints, monitor air quality trends, and coordinate pollution control measures.</p>
                            <ul class="feature-list">
                                <li><i class="fas fa-check-circle"></i> Complaint Management System</li>
                                <li><i class="fas fa-check-circle"></i> Real-time Monitoring Dashboard</li>
                                <li><i class="fas fa-check-circle"></i> Department Analytics & Reports</li>
                                <li><i class="fas fa-check-circle"></i> Inter-department Coordination</li>
                                <li><i class="fas fa-check-circle"></i> Emergency Response Tools</li>
                            </ul>
                            <button class="role-btn" style="background: var(--gov-green);" onclick="window.location.href='auth.html?role=department'">
                                <i class="fas fa-building me-2"></i>Access Department Portal
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Policymaker Card -->
                <div class="col-lg-4">
                    <div class="role-card">
                        <div class="role-header" style="background: linear-gradient(135deg, #8B0000 0%, #B22222 100%);">
                            <div class="role-icon">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <h3>Policymaker</h3>
                            <p class="mb-0">Decision Makers Portal</p>
                        </div>
                        <div class="role-body">
                            <p>Analyze data, evaluate policy effectiveness, and make informed decisions for cleaner air.</p>
                            <ul class="feature-list">
                                <li><i class="fas fa-check-circle"></i> Policy Analysis Dashboard</li>
                                <li><i class="fas fa-check-circle"></i> Citizen Sentiment Analysis</li>
                                <li><i class="fas fa-check-circle"></i> Impact Assessment Tools</li>
                                <li><i class="fas fa-check-circle"></i> Data Visualization Suite</li>
                                <li><i class="fas fa-check-circle"></i> Report Generation System</li>
                            </ul>
                            <button class="role-btn" style="background: #8B0000;" onclick="window.location.href='auth.html?role=policymaker'">
                                <i class="fas fa-chart-line me-2"></i>Access Policymaker Portal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats-section">
        <div class="container">
            <div class="row text-center">
                <div class="col-md-3 col-6 mb-4">
                    <div class="stat-number">30M+</div>
                    <div class="stat-label">Citizens Served</div>
                </div>
                <div class="col-md-3 col-6 mb-4">
                    <div class="stat-number">500+</div>
                    <div class="stat-label">AQI Sensors</div>
                </div>
                <div class="col-md-3 col-6 mb-4">
                    <div class="stat-number">15K+</div>
                    <div class="stat-label">Complaints Resolved</div>
                </div>
                <div class="col-md-3 col-6 mb-4">
                    <div class="stat-number">24/7</div>
                    <div class="stat-label">Real-time Monitoring</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="features-section" id="features">
        <div class="container">
            <h2 class="text-center section-title">Comprehensive Features</h2>
            <p class="text-center text-muted mb-5">Advanced tools for air quality management across all stakeholders</p>
            
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-satellite"></i>
                        </div>
                        <h4>Real-time Monitoring</h4>
                        <p>Live AQI data from 500+ sensors across Delhi-NCR with automated alerts and notifications.</p>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h4>AI-Powered Analytics</h4>
                        <p>Machine learning algorithms for pollution prediction and source attribution analysis.</p>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <h4>Grievance Redressal</h4>
                        <p>Streamlined complaint management system with photo evidence and status tracking.</p>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h4>Health Protection</h4>
                        <p>AQI shelters, health recommendations, and breathing exercises for citizen safety.</p>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h4>Policy Analysis</h4>
                        <p>Comprehensive tools for evaluating policy effectiveness and citizen feedback.</p>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-language"></i>
                        </div>
                        <h4>Multi-Language Support</h4>
                        <p>Available in Hindi, English, and regional languages for maximum accessibility.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="gov-footer" id="contact">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="footer-logo">
                        <i class="fas fa-wind me-2"></i>AQI NCR Delhi
                    </div>
                    <p class="text-light">
                        Official Air Quality Management Portal<br>
                        Government of NCT of Delhi<br>
                        <i>Swachh Vayu, Swasth Bharat</i>
                    </p>
                    <div class="mt-3">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Flag_of_India.svg/640px-Flag_of_India.svg.png" 
                             alt="Indian Flag" height="40" class="me-2">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/Emblem_of_Delhi.svg/640px-Emblem_of_Delhi.svg.png" 
                             alt="Delhi Emblem" height="40">
                    </div>
                </div>
                
                <div class="col-lg-2 col-6 mb-4">
                    <div class="footer-links">
                        <h5>Quick Links</h5>
                        <ul>
                            <li><a href="#">Home</a></li>
                            <li><a href="#dashboard">Live Dashboard</a></li>
                            <li><a href="#predictions">AI Predictions</a></li>
                            <li><a href="#roles">Portals</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="col-lg-3 col-6 mb-4">
                    <div class="footer-links">
                        <h5>Resources</h5>
                        <ul>
                            <li><a href="#">AQI Guidelines</a></li>
                            <li><a href="#">Health Advisories</a></li>
                            <li><a href="#">Policy Documents</a></li>
                            <li><a href="#">Research Papers</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="col-lg-3 mb-4">
                    <div class="footer-links">
                        <h5>Contact</h5>
                        <ul class="list-unstyled text-light">
                            <li class="mb-2">
                                <i class="fas fa-envelope me-2"></i> 
                                aqi.help@delhi.gov.in
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-phone me-2"></i> 
                                011-23860182
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                Delhi Secretariat, ITO, New Delhi
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-clock me-2"></i>
                                Mon-Sat: 9:00 AM - 6:00 PM
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="copyright">
                <p class="mb-2">
                    ¬© 2025 Government of NCT of Delhi. All Rights Reserved. | 
                    <a href="#" class="text-light">Privacy Policy</a> | 
                    <a href="#" class="text-light">Terms of Service</a>
                </p>
                <p class="mb-0">
                    This is the Official Air Quality Portal of Delhi Government. 
                    Content managed by Delhi Pollution Control Committee (DPCC)
                </p>
            </div>
        </div>
    </footer>

    <!-- GRAP Modal -->
    <div class="modal fade" id="grapModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="grapTitle">GRAP Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-light border shadow-sm mb-3">
                        <i class="fas fa-exclamation-circle text-danger me-2"></i>
                        <span id="grapStatusText">Loading status...</span>
                    </div>
                    <h6>Active Restrictions:</h6>
                    <ul class="list-group list-group-flush small" id="grapList">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet JS for Maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================
        // MAIN AQI DASHBOARD FUNCTIONS
        // ============================
        
        // Configuration
        const AQICN_API_KEY = "fd450ba08a33536eb388e7256cc45f3a69a34887";
        const AQICN_API_URL = "https://api.waqi.info/feed/";
        
        let mapInstance = null;
        let mapMarker = null;
        let currentStation = null;
        let predictor = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize app
            initApp();
            
            // Dropdown Listener
            document.getElementById('stationSelect').addEventListener('change', function() {
                if (this.value === 'current') {
                    resetToCurrentLocation();
                } else {
                    const [lat, lon] = this.value.split(',');
                    enhancedLoadData(parseFloat(lat), parseFloat(lon));
                }
            });
            
            // Smooth scrolling for anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    if (targetId === '#') return;
                    
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 80,
                            behavior: 'smooth'
                        });
                    }
                });
            });
            
            // Initialize failure predictor
            predictor = new FailurePredictor();
        });

        async function initApp() {
            // Hide loader after page loads
            setTimeout(hideLoader, 1500);
            
            // Initialize stats animation
            animateStats();
            
            // Start with current location
            resetToCurrentLocation();
        }

        function animateStats() {
            const stats = document.querySelectorAll('.stat-number');
            stats.forEach(stat => {
                const target = parseInt(stat.innerText);
                const increment = target / 50;
                let current = 0;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        clearInterval(timer);
                        stat.innerText = target.toLocaleString() + '+';
                    } else {
                        stat.innerText = Math.floor(current).toLocaleString() + '+';
                    }
                }, 30);
            });
        }

        async function resetToCurrentLocation() {
            showLoader("Acquiring GPS location...");
            document.getElementById('stationSelect').value = 'current';
            
            try {
                const pos = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        timeout: 10000,
                        enableHighAccuracy: true
                    });
                });
                
                enhancedLoadData(pos.coords.latitude, pos.coords.longitude);
            } catch (e) {
                console.log("GPS Failed/Denied, using default location.");
                // Fallback to ITO Delhi
                enhancedLoadData(28.6317, 77.2457);
                document.getElementById('currentLocation').textContent = "ITO, New Delhi (Default)";
            }
        }

        async function enhancedLoadData(lat, lon) {
            showLoader("Fetching air quality data...");
            
            try {
                // First try to get nearest station using AQICN API
                const geoUrl = `${AQICN_API_URL}geo:${lat};${lon}/?token=${AQICN_API_KEY}`;
                const response = await fetch(geoUrl);
                
                // Check for API failures
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === "ok") {
                    renderDashboard(data.data);
                    
                    // Log data collection success for ML training
                    logDataCollection('success', {
                        location: `${lat},${lon}`,
                        timestamp: new Date().toISOString(),
                        aqi: data.data.aqi
                    });
                    
                    // Check for data anomalies
                    checkDataAnomalies(data.data);
                    
                    hideLoader();
                } else {
                    throw new Error("Invalid API response");
                }
            } catch (error) {
                console.error("Data fetch error:", error);
                
                // Log failure for prediction model
                logDataCollection('failure', {
                    error: error.message,
                    location: `${lat},${lon}`,
                    timestamp: new Date().toISOString()
                });

                updateHeatmapChart() {
    const ctx = document.getElementById('failureHeatmapChart');
    if (!ctx) return;
    
    // Get or create chart instance
    if (!this.heatmapChart) {
        // Prepare heatmap data for Delhi NCR regions
        const heatmapData = this.generateHeatmapData();
        
        this.heatmapChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: heatmapData.map(item => item.location),
                datasets: [{
                    label: 'Failure Probability',
                    data: heatmapData.map(item => item.risk),
                    backgroundColor: heatmapData.map(item => {
                        if (item.risk > 60) return 'rgba(220, 53, 69, 0.7)';
                        if (item.risk > 30) return 'rgba(255, 193, 7, 0.7)';
                        return 'rgba(40, 167, 69, 0.7)';
                    }),
                    borderColor: heatmapData.map(item => {
                        if (item.risk > 60) return 'rgba(220, 53, 69, 1)';
                        if (item.risk > 30) return 'rgba(255, 193, 7, 1)';
                        return 'rgba(40, 167, 69, 1)';
                    }),
                    borderWidth: 1,
                    borderRadius: 3,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Risk: ${context.parsed.y}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Failure Probability'
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            },
                            maxRotation: 45
                        }
                    }
                }
            }
        });
    } else {
        // Update existing chart
        const heatmapData = this.generateHeatmapData();
        this.heatmapChart.data.labels = heatmapData.map(item => item.location);
        this.heatmapChart.data.datasets[0].data = heatmapData.map(item => item.risk);
        this.heatmapChart.data.datasets[0].backgroundColor = heatmapData.map(item => {
            if (item.risk > 60) return 'rgba(220, 53, 69, 0.7)';
            if (item.risk > 30) return 'rgba(255, 193, 7, 0.7)';
            return 'rgba(40, 167, 69, 0.7)';
        });
        this.heatmapChart.update();
    }
    
    // Update heatmap statistics
    this.updateHeatmapStats();
}

generateHeatmapData() {
    // Generate mock heatmap data for Delhi NCR regions
    const locations = [
        'Anand Vihar', 'ITO Delhi', 'Punjabi Bagh', 'Dwarka', 
        'Noida Sec 62', 'Gurugram', 'Faridabad', 'Ghaziabad'
    ];
    
    // Use actual sensor data if available, otherwise generate realistic data
    return locations.map(location => {
        // Try to find sensor data for this location
        const sensor = this.predictionData.sensors.find(s => 
            s.location.includes(location.split(' ')[0]));
        
        let risk;
        if (sensor) {
            risk = Math.round(sensor.failureProbability * 100);
        } else {
            // Generate realistic risk values based on location
            const baseRisks = {
                'Anand Vihar': 82,
                'ITO Delhi': 65,
                'Punjabi Bagh': 45,
                'Dwarka': 15,
                'Noida Sec 62': 73,
                'Gurugram': 88,
                'Faridabad': 58,
                'Ghaziabad': 62
            };
            risk = baseRisks[location] || Math.floor(Math.random() * 100);
            
            // Add some random variation
            const variation = (Math.random() - 0.5) * 10;
            risk = Math.max(0, Math.min(100, Math.round(risk + variation)));
        }
        
        return {
            location: location,
            risk: risk
        };
    }).sort((a, b) => b.risk - a.risk); // Sort by risk descending
}

updateHeatmapStats() {
    const heatmapData = this.generateHeatmapData();
    
    if (heatmapData.length > 0) {
        // Highest risk
        const highest = heatmapData[0];
        document.getElementById('highestRiskLocation').textContent = highest.location;
        document.getElementById('highestRiskValue').textContent = `${highest.risk}%`;
        
        // Lowest risk
        const lowest = heatmapData[heatmapData.length - 1];
        document.getElementById('lowestRiskLocation').textContent = lowest.location;
        document.getElementById('lowestRiskValue').textContent = `${lowest.risk}%`;
        
        // Average risk
        const avgRisk = Math.round(heatmapData.reduce((sum, item) => sum + item.risk, 0) / heatmapData.length);
        document.getElementById('avgRiskValue').textContent = `${avgRisk}%`;
        document.getElementById('avgRiskValue').className = 
            avgRisk > 60 ? 'badge bg-danger' : 
            avgRisk > 30 ? 'badge bg-warning' : 'badge bg-success';
    }
}
                
                // Show prediction alert
                if (predictor) {
                    predictor.addImmediateAlert('warning', 
                        `Data fetch failed for ${lat},${lon}. Using fallback data.`, 
                        'Just now');
                }
                
                renderMockData(lat, lon);
                hideLoader();
            }
        }

        function renderDashboard(data) {
            const aqi = data.aqi;
            const city = data.city || { name: "Unknown Station" };
            const iaqi = data.iaqi || {};
            const dominentPol = data.dominentpol || "pm25";
            
            // Update station info
            document.getElementById('stationName').textContent = city.name.toUpperCase();
            document.getElementById('currentLocation').textContent = city.name;
            currentStation = city.name;
            
            // Update AQI
            document.getElementById('mainAQI').textContent = aqi || "--";
            document.getElementById('domPol').textContent = dominentPol.toUpperCase();
            
            // Update AQI category badge
            updateAQICategory(aqi);
            
            // Update pollutant values
            updatePollutantValues(iaqi);
            
            // Update map
            if (data.city && data.city.geo) {
                renderMap(data.city.geo[0], data.city.geo[1], city.name, aqi);
            }
            
            // Update GRAP
            updateGRAP(aqi);
        }

        function updatePollutantValues(iaqi) {
            // Helper function to get pollutant value
            const getValue = (pollutant) => {
                return iaqi[pollutant] ? iaqi[pollutant].v : "--";
            };
            
            // Update all pollutant displays
            document.getElementById('p-pm25').textContent = getValue('pm25');
            document.getElementById('p-pm10').textContent = getValue('pm10');
            document.getElementById('p-no2').textContent = getValue('no2');
            document.getElementById('p-so2').textContent = getValue('so2');
            document.getElementById('p-o3').textContent = getValue('o3');
            document.getElementById('p-co').textContent = getValue('co');
            
            // Temperature and humidity (if available)
            document.getElementById('p-temp').textContent = getValue('t') || "24";
            document.getElementById('p-hum').textContent = getValue('h') || "45";
        }

        function updateAQICategory(aqi) {
            const badge = document.getElementById('mainAQICategory');
            
            if (!aqi || aqi === "--") {
                badge.textContent = "No Data";
                badge.className = "aqi-category bg-secondary";
                return;
            }
            
            let category, categoryClass;
            
            if (aqi <= 50) {
                category = "GOOD";
                categoryClass = "aqi-bg-good";
            } else if (aqi <= 100) {
                category = "SATISFACTORY";
                categoryClass = "aqi-bg-sat";
            } else if (aqi <= 200) {
                category = "MODERATE";
                categoryClass = "aqi-bg-mod";
            } else if (aqi <= 300) {
                category = "POOR";
                categoryClass = "aqi-bg-poor";
            } else if (aqi <= 400) {
                category = "VERY POOR";
                categoryClass = "aqi-bg-vpoor";
            } else if (aqi <= 500) {
                category = "SEVERE";
                categoryClass = "aqi-bg-severe";
            } else {
                category = "HAZARDOUS";
                categoryClass = "aqi-bg-hazardous";
            }
            
            badge.textContent = category;
            badge.className = `aqi-category ${categoryClass}`;
        }

        function updateGRAP(aqi) {
            const link = document.getElementById('grapLink');
            const title = document.getElementById('grapTitle');
            const status = document.getElementById('grapStatusText');
            const list = document.getElementById('grapList');
            
            let stage, items, color;
            
            if (!aqi || aqi <= 200) {
                stage = "No GRAP";
                items = ["Routine pollution control measures only.", "No emergency bans active."];
                color = "#28a745";
            } else if (aqi <= 300) {
                stage = "GRAP Stage 1 (Poor)";
                items = [
                    "Stop C&D activities on plot size ‚â• 500 sqm (unregistered)",
                    "Ban on open burning of waste",
                    "Periodic mechanized sweeping of roads"
                ];
                color = "#ffc107";
            } else if (aqi <= 400) {
                stage = "GRAP Stage 2 (Very Poor)";
                items = [
                    "Ban on Diesel Generators (except essential)",
                    "Hike in parking fees to discourage private cars",
                    "Augmented Bus/Metro frequency"
                ];
                color = "#fd7e14";
            } else if (aqi <= 450) {
                stage = "GRAP Stage 3 (Severe)";
                items = [
                    "<b>Ban on BS-III Petrol & BS-IV Diesel Cars</b>",
                    "Strict Ban on Construction & Demolition",
                    "Closure of stone crushers & mining"
                ];
                color = "#dc3545";
            } else {
                stage = "GRAP Stage 4 (Severe +)";
                items = [
                    "<b>Ban on Truck Entry into Delhi</b>",
                    "Ban on Delhi registered diesel MGV/HGV",
                    "Schools closed / Online classes active"
                ];
                color = "#6f42c1";
            }
            
            link.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i> ${stage}`;
            link.style.borderColor = color;
            link.style.color = (aqi > 200) ? '#dc3545' : '#333';
            
            title.textContent = stage;
            status.textContent = `Current AQI: ${aqi || '--'}. Restrictions in force:`;
            list.innerHTML = items.map(i => `<li class="list-group-item"><i class="fas fa-caret-right me-2"></i>${i}</li>`).join('');
        }

        function renderMap(lat, lon, name, aqi) {
            if (!mapInstance) {
                mapInstance = L.map('aqiMap').setView([lat, lon], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(mapInstance);
            } else {
                mapInstance.setView([lat, lon], 13);
            }
            
            // Remove existing marker
            if (mapMarker) {
                mapInstance.removeLayer(mapMarker);
            }
            
            // Determine marker color based on AQI
            let markerColor = 'gray';
            if (aqi) {
                if (aqi <= 50) markerColor = 'green';
                else if (aqi <= 100) markerColor = '#87c159';
                else if (aqi <= 200) markerColor = 'yellow';
                else if (aqi <= 300) markerColor = 'orange';
                else if (aqi <= 400) markerColor = 'red';
                else markerColor = 'purple';
            }
            
            // Add new marker
            mapMarker = L.circleMarker([lat, lon], {
                color: markerColor,
                fillColor: markerColor,
                fillOpacity: 0.7,
                radius: 25
            }).addTo(mapInstance);
            
            // Add popup
            mapMarker.bindPopup(`
                <div style="min-width: 200px">
                    <h6><b>${name}</b></h6>
                    <div class="mb-2">AQI: <strong>${aqi || '--'}</strong></div>
                    <small><i class="fas fa-clock"></i> Updated just now</small>
                </div>
            `).openPopup();
            
            // Add AQI legend to map
            if (!document.querySelector('.map-legend')) {
                const legend = L.control({ position: 'bottomright' });
                legend.onAdd = function() {
                    const div = L.DomUtil.create('div', 'info legend map-legend');
                    div.style.backgroundColor = 'white';
                    div.style.padding = '10px';
                    div.style.borderRadius = '5px';
                    div.style.boxShadow = '0 0 15px rgba(0,0,0,0.2)';
                    div.innerHTML = `
                        <h6 style="margin-bottom: 8px"><b>AQI Scale</b></h6>
                        <div><i style="background:green; width:15px; height:15px; display:inline-block; margin-right:5px;"></i> 0-50 (Good)</div>
                        <div><i style="background:#87c159; width:15px; height:15px; display:inline-block; margin-right:5px;"></i> 51-100 (Satisfactory)</div>
                        <div><i style="background:yellow; width:15px; height:15px; display:inline-block; margin-right:5px;"></i> 101-200 (Moderate)</div>
                        <div><i style="background:orange; width:15px; height:15px; display:inline-block; margin-right:5px;"></i> 201-300 (Poor)</div>
                        <div><i style="background:red; width:15px; height:15px; display:inline-block; margin-right:5px;"></i> 301-400 (Very Poor)</div>
                        <div><i style="background:purple; width:15px; height:15px; display:inline-block; margin-right:5px;"></i> 401+ (Severe)</div>
                    `;
                    return div;
                };
                legend.addTo(mapInstance);
            }
        }

        function renderMockData(lat, lon) {
            // Generate realistic mock data for Delhi NCR
            const stations = [
                { name: "ITO, New Delhi", aqi: 325, pm25: 235, pm10: 345, no2: 45, so2: 12, o3: 32, co: 2.1, temp: 24, hum: 45 },
                { name: "Anand Vihar", aqi: 385, pm25: 285, pm10: 412, no2: 52, so2: 15, o3: 28, co: 2.8, temp: 25, hum: 43 },
                { name: "Punjabi Bagh", aqi: 312, pm25: 225, pm10: 335, no2: 41, so2: 11, o3: 35, co: 1.9, temp: 23, hum: 47 },
                { name: "Mandir Marg", aqi: 298, pm25: 210, pm10: 325, no2: 38, so2: 10, o3: 37, co: 1.7, temp: 24, hum: 46 },
                { name: "R.K. Puram", aqi: 345, pm25: 255, pm10: 378, no2: 48, so2: 14, o3: 30, co: 2.4, temp: 25, hum: 44 },
                { name: "Dwarka", aqi: 278, pm25: 195, pm10: 305, no2: 35, so2: 9, o3: 40, co: 1.5, temp: 23, hum: 48 },
                { name: "Noida Sector 62", aqi: 365, pm25: 275, pm10: 398, no2: 50, so2: 16, o3: 26, co: 2.6, temp: 26, hum: 42 },
                { name: "Gurugram", aqi: 395, pm25: 295, pm10: 425, no2: 55, so2: 18, o3: 25, co: 2.9, temp: 26, hum: 41 }
            ];
            
            // Find nearest station based on dropdown selection
            const select = document.getElementById('stationSelect');
            const selectedOption = select.options[select.selectedIndex];
            const stationName = selectedOption.text;
            
            let station = stations.find(s => s.name.includes(stationName.split(' ')[0])) || stations[0];
            
            // Update display
            document.getElementById('stationName').textContent = station.name.toUpperCase();
            document.getElementById('currentLocation').textContent = station.name;
            document.getElementById('mainAQI').textContent = station.aqi;
            document.getElementById('domPol').textContent = "PM2.5";
            
            updateAQICategory(station.aqi);
            
            // Update pollutants
            document.getElementById('p-pm25').textContent = station.pm25;
            document.getElementById('p-pm10').textContent = station.pm10;
            document.getElementById('p-no2').textContent = station.no2;
            document.getElementById('p-so2').textContent = station.so2;
            document.getElementById('p-o3').textContent = station.o3;
            document.getElementById('p-co').textContent = station.co;
            document.getElementById('p-temp').textContent = station.temp;
            document.getElementById('p-hum').textContent = station.hum;
            
            // Update map
            renderMap(lat, lon, station.name, station.aqi);
            
            // Update GRAP
            updateGRAP(station.aqi);
        }

        function checkDataAnomalies(data) {
            const anomalies = [];
            
            // Check for unrealistic AQI values
            if (data.aqi > 500 || data.aqi < 0) {
                anomalies.push({
                    type: 'invalid_aqi',
                    value: data.aqi,
                    severity: 'high'
                });
            }
            
            // Check for missing pollutant data
            if (!data.iaqi || Object.keys(data.iaqi).length < 3) {
                anomalies.push({
                    type: 'incomplete_data',
                    missing: 6 - (data.iaqi ? Object.keys(data.iaqi).length : 0),
                    severity: 'medium'
                });
            }
            
            // Check for data freshness
            if (data.time && data.time.s) {
                const dataTime = new Date(data.time.s);
                const now = new Date();
                const ageHours = (now - dataTime) / (1000 * 60 * 60);
                
                if (ageHours > 3) {
                    anomalies.push({
                        type: 'stale_data',
                        age: ageHours.toFixed(1),
                        severity: 'medium'
                    });
                }
            }
            
            // Report anomalies to prediction system
            if (anomalies.length > 0 && predictor) {
                anomalies.forEach(anomaly => {
                    predictor.addImmediateAlert('warning',
                        `Data anomaly: ${anomaly.type} detected`,
                        'Just now');
                });
            }
        }

        function logDataCollection(status, metadata) {
            // This would send data to your ML backend
            const logEntry = {
                timestamp: new Date().toISOString(),
                status: status,
                metadata: metadata,
                userAgent: navigator.userAgent
            };
            
            // Store locally for now
            const logs = JSON.parse(localStorage.getItem('aqi_logs') || '[]');
            logs.push(logEntry);
            localStorage.setItem('aqi_logs', JSON.stringify(logs.slice(-100))); // Keep last 100 entries
        }

        function showLoader(message) {
            document.getElementById('loaderText').textContent = message;
            document.getElementById('globalLoader').style.opacity = '1';
            document.getElementById('globalLoader').style.pointerEvents = 'all';
        }

        function hideLoader() {
            setTimeout(() => {
                document.getElementById('globalLoader').style.opacity = '0';
                document.getElementById('globalLoader').style.pointerEvents = 'none';
            }, 500);
        }

        // ============================
        // FAILURE PREDICTOR CLASS
        // ============================
        
        class FailurePredictor {
            constructor() {
                this.predictionData = {
                    sensors: [],
                    services: [],
                    anomalies: [],
                    maintenance: []
                };
                this.initializePredictor();
            }

            async initializePredictor() {
                // Load historical data
                await this.loadHistoricalData();
                
                // Start prediction engine
                this.startPredictionEngine();
                
                // Initial prediction
                this.runPredictions();
            }

            async loadHistoricalData() {
                // Mock data - replace with actual API calls
                this.predictionData = {
                    sensors: [
                        { id: "SENSOR_001", location: "ITO, Delhi", age: 3.2, lastMaintenance: "2024-01-15", failureProbability: 0.65, status: "degrading" },
                        { id: "SENSOR_045", location: "Anand Vihar", age: 4.1, lastMaintenance: "2023-11-30", failureProbability: 0.82, status: "critical" },
                        { id: "SENSOR_128", location: "Punjabi Bagh", age: 2.8, lastMaintenance: "2024-02-10", failureProbability: 0.45, status: "normal" },
                        { id: "SENSOR_256", location: "Dwarka", age: 1.5, lastMaintenance: "2024-03-01", failureProbability: 0.15, status: "normal" },
                        { id: "SENSOR_312", location: "Noida Sec 62", age: 3.9, lastMaintenance: "2023-12-20", failureProbability: 0.73, status: "degrading" }
                    ],
                    services: [
                        { name: "AQICN API", uptime: 99.8, responseTime: 145, status: "active" },
                        { name: "GPS Service", uptime: 98.2, responseTime: 210, status: "degraded" },
                        { name: "Map Services", uptime: 99.9, responseTime: 89, status: "active" },
                        { name: "Data Processing", uptime: 99.5, responseTime: 167, status: "active" }
                    ],
                    anomalies: [
                        { type: "data_spike", location: "RK Puram", severity: "high", timestamp: new Date().toISOString() },
                        { type: "missing_data", location: "Mandir Marg", severity: "medium", timestamp: new Date().toISOString() },
                        { type: "calibration_drift", location: "Gurugram", severity: "low", timestamp: new Date().toISOString() }
                    ],
                    maintenance: [
                        { sensorId: "SENSOR_045", location: "Anand Vihar", schedule: "2024-04-05", priority: "urgent" },
                        { sensorId: "SENSOR_001", location: "ITO, Delhi", schedule: "2024-04-10", priority: "high" },
                        { sensorId: "SENSOR_312", location: "Noida Sec 62", schedule: "2024-04-15", priority: "medium" }
                    ]
                };
            }

            startPredictionEngine() {
                // Run predictions every 30 minutes
                setInterval(() => this.runPredictions(), 30 * 60 * 1000);
                
                // Check for immediate alerts every 5 minutes
                setInterval(() => this.checkImmediateAlerts(), 5 * 60 * 1000);
            }

            runPredictions() {
                this.predictSensorFailures();
                this.detectDataAnomalies();
                this.analyzeServiceHealth();
                this.updatePredictiveMaintenance();
                this.updateUI();
            }

            predictSensorFailures() {
                // AI algorithm to predict sensor failures
                this.predictionData.sensors.forEach(sensor => {
                    // Calculate failure probability (simplified version)
                    const baseProbability = sensor.age > 3 ? 0.6 : 0.3;
                    const maintenanceFactor = this.getDaysSinceMaintenance(sensor.lastMaintenance) > 90 ? 0.3 : 0.1;
                    const randomFactor = Math.random() * 0.2;
                    
                    sensor.failureProbability = Math.min(0.95, baseProbability + maintenanceFactor + randomFactor);
                    
                    // Update status based on probability
                    if (sensor.failureProbability > 0.7) {
                        sensor.status = "critical";
                    } else if (sensor.failureProbability > 0.4) {
                        sensor.status = "degrading";
                    } else {
                        sensor.status = "normal";
                    }
                });
            }

            detectDataAnomalies() {
                // AI anomaly detection
                const newAnomalies = [
                    {
                        type: Math.random() > 0.5 ? "data_spike" : "missing_data",
                        location: this.getRandomLocation(),
                        severity: Math.random() > 0.7 ? "high" : (Math.random() > 0.4 ? "medium" : "low"),
                        timestamp: new Date().toISOString()
                    }
                ];
                
                this.predictionData.anomalies = [...newAnomalies, ...this.predictionData.anomalies.slice(0, 4)];
            }

            analyzeServiceHealth() {
                // Monitor API health, response times, and error rates
                this.predictionData.services.forEach(service => {
                    // Simulate service health fluctuations
                    const fluctuation = (Math.random() - 0.5) * 0.5;
                    service.uptime = Math.max(95, Math.min(100, service.uptime + fluctuation));
                    
                    // Simulate response time variations
                    const timeVariation = (Math.random() - 0.5) * 30;
                    service.responseTime = Math.max(50, Math.min(500, service.responseTime + timeVariation));
                    
                    // Update status
                    if (service.uptime < 98 || service.responseTime > 300) {
                        service.status = "degraded";
                    } else if (service.uptime < 99) {
                        service.status = "warning";
                    } else {
                        service.status = "active";
                    }
                });
            }

            updatePredictiveMaintenance() {
                // Generate maintenance schedule based on predictions
                const criticalSensors = this.predictionData.sensors
                    .filter(s => s.failureProbability > 0.6)
                    .sort((a, b) => b.failureProbability - a.failureProbability);
                
                this.predictionData.maintenance = criticalSensors.slice(0, 3).map(sensor => ({
                    sensorId: sensor.id,
                    location: sensor.location,
                    schedule: this.getNextMaintenanceDate(sensor.failureProbability),
                    priority: sensor.failureProbability > 0.8 ? "urgent" : 
                             sensor.failureProbability > 0.6 ? "high" : "medium"
                }));
            }

            updateUI() {
                // Update sensor risk list
                const riskList = document.getElementById('sensorRiskList');
                const criticalSensors = this.predictionData.sensors
                    .filter(s => s.failureProbability > 0.6)
                    .slice(0, 5);
                
                riskList.innerHTML = criticalSensors.map(sensor => `
                    <li>
                        <i class="fas fa-exclamation-circle ${sensor.failureProbability > 0.8 ? 'text-danger' : 'text-warning'}"></i>
                        ${sensor.location} (${Math.round(sensor.failureProbability * 100)}% risk)
                    </li>
                `).join('');
                
                // Update at-risk sensors count
                const atRiskCount = this.predictionData.sensors.filter(s => s.failureProbability > 0.6).length;
                document.getElementById('atRiskSensors').textContent = atRiskCount;
                
                // Update predicted failures
                const predictedCount = Math.ceil(atRiskCount * 0.3);
                document.getElementById('predictedFailures').textContent = `${predictedCount}-${predictedCount + 2}`;
                
                // Update anomalies count
                document.getElementById('anomaliesCount').textContent = this.predictionData.anomalies.length;
                
                // Update data quality (simulated)
                const qualityScore = 100 - (this.predictionData.anomalies.length * 2);
                document.getElementById('dataQuality').textContent = `${Math.max(70, qualityScore)}%`;
                document.getElementById('dataQualityBar').style.width = `${Math.max(70, qualityScore)}%`;
                
                // Update system metrics
                document.getElementById('systemUptime').textContent = 
                    `${Math.min(...this.predictionData.services.map(s => s.uptime)).toFixed(1)}%`;
                
                document.getElementById('avgResponse').textContent = 
                    `${Math.round(this.predictionData.services.reduce((a, b) => a + b.responseTime, 0) / 
                    this.predictionData.services.length)}ms`;
                
                // Update maintenance schedule table
                const maintenanceTable = document.getElementById('maintenanceSchedule');
                maintenanceTable.innerHTML = this.predictionData.maintenance.map(item => `
                    <tr>
                        <td><code>${item.sensorId}</code></td>
                        <td>${item.location}</td>
                        <td>${this.getDaysSinceLastMaintenance(item.sensorId)} days ago</td>
                        <td><span class="badge ${item.priority === 'urgent' ? 'bg-danger' : 
                                                 item.priority === 'high' ? 'bg-warning' : 'bg-info'}">${item.schedule}</span></td>
                        <td><button class="btn btn-sm btn-outline-primary">Schedule</button></td>
                    </tr>
                `).join('');
                
                // Generate alerts
                this.generateAlerts();
            }

            generateAlerts() {
                const alertsContainer = document.getElementById('predictionAlerts');
                const alerts = [];
                
                // Check for critical sensors
                const criticalSensors = this.predictionData.sensors.filter(s => s.failureProbability > 0.8);
                criticalSensors.forEach(sensor => {
                    alerts.push({
                        type: 'critical',
                        message: `CRITICAL: ${sensor.location} sensor has ${Math.round(sensor.failureProbability * 100)}% failure probability`,
                        time: 'Just now'
                    });
                });
                
                // Check for service degradation
                const degradedServices = this.predictionData.services.filter(s => s.status === 'degraded');
                degradedServices.forEach(service => {
                    alerts.push({
                        type: 'warning',
                        message: `WARNING: ${service.name} performance degraded (Uptime: ${service.uptime.toFixed(1)}%)`,
                        time: '5 mins ago'
                    });
                });
                
                // Check for data anomalies
                this.predictionData.anomalies.filter(a => a.severity === 'high').forEach(anomaly => {
                    alerts.push({
                        type: 'warning',
                        message: `ANOMALY: ${anomaly.type.replace('_', ' ')} detected at ${anomaly.location}`,
                        time: '10 mins ago'
                    });
                });
                
                // Update alerts UI
                alertsContainer.innerHTML = alerts.map(alert => `
                    <div class="alert-item ${alert.type === 'critical' ? 'critical' : 
                                           alert.type === 'warning' ? 'warning' : 'info'}">
                        <div class="alert-icon">
                            <i class="fas ${alert.type === 'critical' ? 'fa-skull-crossbones' : 
                                          alert.type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                        </div>
                        <div class="alert-content">
                            <div>${alert.message}</div>
                            <div class="alert-time">${alert.time}</div>
                        </div>
                    </div>
                `).join('');
            }

            checkImmediateAlerts() {
                // Check for immediate issues that need attention
                const now = new Date();
                const hour = now.getHours();
                
                // Simulate peak load issues during business hours
                if (hour >= 9 && hour <= 18) {
                    const loadFactor = Math.random();
                    if (loadFactor > 0.8) {
                        this.addImmediateAlert('warning', 
                            'High system load detected. Consider scaling resources.', '2 mins ago');
                    }
                }
            }

            addImmediateAlert(type, message, time) {
                const alertsContainer = document.getElementById('predictionAlerts');
                const alertHTML = `
                    <div class="alert-item ${type}">
                        <div class="alert-icon">
                            <i class="fas ${type === 'critical' ? 'fa-skull-crossbones' : 
                                          type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                        </div>
                        <div class="alert-content">
                            <div>${message}</div>
                            <div class="alert-time">${time}</div>
                        </div>
                    </div>
                `;
                
                alertsContainer.insertAdjacentHTML('afterbegin', alertHTML);
            }

            // Helper methods
            getDaysSinceMaintenance(dateString) {
                const lastDate = new Date(dateString);
                const now = new Date();
                return Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));
            }

            getNextMaintenanceDate(probability) {
                const days = probability > 0.8 ? 5 : 
                            probability > 0.6 ? 10 : 
                            probability > 0.4 ? 15 : 30;
                
                const date = new Date();
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0];
            }

            getDaysSinceLastMaintenance(sensorId) {
                const sensor = this.predictionData.sensors.find(s => s.id === sensorId);
                return sensor ? this.getDaysSinceMaintenance(sensor.lastMaintenance) : 0;
            }

            getRandomLocation() {
                const locations = ["ITO, Delhi", "Anand Vihar", "Punjabi Bagh", "Dwarka", 
                                  "Noida Sec 62", "Gurugram", "Faridabad", "Ghaziabad"];
                return locations[Math.floor(Math.random() * locations.length)];
            }
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================
        
        window.refreshPredictions = function() {
            if (predictor) {
                predictor.runPredictions();
                showToast('Predictions refreshed successfully');
            }
        };
        
        window.viewSensorHealth = function() {
            // Navigate to detailed sensor health page
            showToast('Opening sensor health dashboard...');
            // In production, this would navigate to a detailed page
            // window.location.href = 'sensor-health.html';
        };

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-alert';
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas fa-check-circle me-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            if (currentStation) {
                const select = document.getElementById('stationSelect');
                if (select.value === 'current') {
                    resetToCurrentLocation();
                } else {
                    const [lat, lon] = select.value.split(',');
                    enhancedLoadData(parseFloat(lat), parseFloat(lon));
                }
            }
        }, 300000); // 5 minutes


        
    </script>
</body>
</html>
